<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="https://www.layuicdn.com/layui/css/layui.css">
    <style>
        #editor {
            border: 1px dashed #333333;
            width: 100%;
            height: 100%;
        }
        
        html,
        body {
            height: 100%;
            padding: 0;
            margin: 0;
        }
        
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body style="height: 100%; margin: 0; padding: 0;">
    <div id="app" v-cloak style="height: 100%; margin: 0;">
        <form class="layui-form">
            <div class="layui-form-item">
                <label class="layui-form-label">标题</label>
                <div class="layui-input-block layui-input-inline">
                    <input v-model="title" type="text" id="title" class="layui-input">
                </div>
            </div>

            <label class="layui-form-label">分类</label>
            <div class="layui-input-block  layui-input-inline">
                <select @change="big_group_change();" v-model="big_group_index" id="big_group" lay-ignore>
                    <option v-for="(bt, index) in group_data" :value="index" v-if="bt.sub_group.length !== 0">
                        {{ bt.group_name }}
                    </option>
                </select>
            </div>
            <div class="layui-input-block layui-input-inline">
                <select v-model="sub_group" lay-ignore v-if="group_data.length !== 0">
                    <option v-for="st in group_data[big_group_index].sub_group" :value="st.id">
                        {{st.group_name}}
                    </option>
                </select>
            </div>
            <div class=layui-form-item>
                <button @click="publish();" class="layui-btn layui-btn-green" type="button">发布</button>
                <button type="button" @click="save_draft();" class="layui-btn layui-btn-normal">保存为草稿</button>
                <input lay-ignore type="checkbox" v-model="auto_save_flag" @change="auto_save_draft();">自动保存</button>
            </div>
        </form>
        <div class="layui-row" style="height:80%; margin:0;">
            <div class="layui-col-md5" style="height: 100%;">
                <pre id="editor"></pre>
            </div>
            <div class="layui-col-md5" style="overflow: hidden; height: 100%;">
                <iframe id="html_content" src="/admin/html/show_blog.html" style="width:100%; height: 100%;"></iframe>

            </div>
            <div class="layui-col-md2" style="min-height:100%; background: linen">

            </div>
        </div>
    </div>
    <script type="text/javascript" src="https://www.layuicdn.com/layui/layui.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.4.5/ace.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.4.5/ext-language_tools.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.4.5/ext-emmet.js"></script>
    <script src="https://cdn.bootcss.com/ace/1.4.5/ext-elastic_tabstops_lite.js"></script>

    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>

    <script src="https://cdn.bootcss.com/showdown/1.9.0/showdown.min.js"></script>
    <script>
        let on_set_draft_data = null;
        let app = new Vue({
            el: "#app",
            data: << data >> ,
            methods: {
                big_group_change: function() {
                    let flag = false;
                    for (let k in this.group_data[this.big_group_index].sub_group) {
                        if (this.sub_group === this.group_data[this.big_group_index].sub_group[k].id) {
                            flag = true;
                            break;
                        }
                    }
                    if (!flag) {
                        this.sub_group = this.group_data[this.big_group_index].sub_group[0].id;
                    }
                },
                auto_save_draft: function() {
                    if (this.auto_save_flag) {
                        this.timer = window.setInterval(this.auto_save, 10 * 1000);
                    } else {
                        window.clearInterval(this.timer);
                    }
                },
                publish: function() {
                    let this_ = this;
                    layui.use(["jquery", "layer"], function() {
                        let layer = layui.layer;
                        let $ = layui.jquery;
                        if (this_.title === "") {
                            layer.msg("请填写标题", {
                                icon: 0
                            });
                            return false;
                        }
                        if (this_.sub_group == -1) {
                            layer.msg("请选择分类", {
                                icon: 0
                            });
                            return false;
                        }
                        console.log({
                            draft_id: this_.draft_id,
                            blog_id: this_.blog_id,
                            title: this_.title,
                            content: this_.editor.getValue(),
                            sub_group: this_.sub_group
                        })
                        $.ajax({
                            url: "/admin/api/blog",
                            method: "POST",
                            data: {
                                draft_id: this_.draft_id,
                                blog_id: this_.blog_id,
                                title: this_.title,
                                content: this_.editor.getValue(),
                                sub_group: this_.sub_group
                            },
                            success: function(res) {
                                if (res.code !== 0) {
                                    layer.msg(res.msg, {
                                        icon: 0
                                    });
                                } else {
                                    window.clearInterval(this_.timer);
                                    layer.alert("发布成功", () => {
                                        window.location.href = "/admin/html/blog_data.html";
                                    });
                                }
                            }
                        });

                    });


                },

                on_set_draft_data: function(index) {
                    let this_ = this;
                    layui.use(["layer"], function() {
                        let layer = layui.layer;
                        this_.title = draft_data[index].title;
                        this_.editor.setValue(draft_data[index].content);
                        this_.draft_id = draft_data[index].id;
                        layer.closeAll();
                    });
                },

                save: function(succ_callback, err_callback) {
                    let this_ = this;
                    layui.use(["jquery"], function() {
                        let $ = layui.jquery;
                        let content = this_.editor.getValue();
                        let title = this_.title;
                        if (this_.draft_id === -1 && title.length === 0) {
                            return;
                        }
                        $.ajax({
                            url: "/admin/api/draft",
                            method: "PUT",
                            data: {
                                id: this_.draft_id,
                                title: title,
                                content: content
                            },
                            success: function(res) {
                                if (res.code !== 0) {
                                    err_callback(res.msg);
                                } else {
                                    this_.draft_id = res.data;
                                    succ_callback();
                                }
                            }
                        });
                    });
                },

                save_draft: function() {
                    let this_ = this;
                    layui.use(["layer"], function() {
                        this_.save(() => {
                            layer.msg("保存草稿成功", {
                                icon: 1
                            });
                        }, (msg) => {
                            layer.msg(msg, {
                                icon: 0
                            });
                        });
                    });
                },

                auto_save: function() {
                    let this_ = this;
                    layui.use(["layer"], function() {
                        this_.save(() => {}, (msg) => {
                            layer.msg(msg, {
                                icon: 0
                            });
                        });
                    });
                },

                get_blog_content: function() {
                    let this_ = this;
                    layui.use(["jquery", "layer"], function() {
                        let layer = layui.layer;
                        let $ = layui.jquery;
                        $.ajax({
                            url: "/admin/api/blog_content",
                            method: "GET",
                            data: {
                                id: this_.blog_id
                            },
                            success: function(res) {
                                if (res.code !== 0) {
                                    layer.msg(res.msg, {
                                        icon: 0
                                    });
                                } else {
                                    this_.editor.setValue(res.data.content);
                                }
                            }
                        });
                    });
                },

                get_draft: function() {
                    let this_ = this;
                    layui.use(["jquery", "layer"], function() {
                        let $ = layui.jquery;
                        let layer = layui.layer;
                        $.ajax({
                            url: "/admin/api/draft",
                            method: "GET",
                            data: {
                                id: this_.draft_id
                            },
                            success: function(res) {
                                if (res.code !== 0) {
                                    layer.msg(res.msg, {
                                        icon: 0
                                    });
                                } else {
                                    this_.title = res.data.title;
                                    this_.editor.setValue(res.data.content);
                                }
                            }
                        });
                    });
                },

                get_draft_list: function() {
                    let this_ = this;
                    layui.use(["jquery"], function() {
                        let $ = layui.jquery;


                        let html_encode = function(html) {
                            return $("<div>").text(html).html();
                        };

                        $.ajax({
                            url: "/admin/api/draft_list",
                            method: "GET",
                            success: function(res) {
                                if (res.code !== 0) {
                                    layer.msg(res.msg, {
                                        icon: 0
                                    });
                                } else {
                                    if (res.data.length !== 0) {
                                        layer.confirm("检测到有草稿，是否继续编辑？", function() {
                                            draft_data = res.data;
                                            let layer_content = "<table class='layui-table'><colgroup><col><col><col></colgroup><thead><td>序号</td><td>标题</td><td>操作</td></thead>";
                                            for (let k in res.data) {
                                                layer_content += "<tr><td>" + k + "</td><td>" + html_encode(res.data[k].title) + "</td><td><button class='layui-btn' onclick='on_set_draft_data(" + k + ");' >编辑</button></td></tr>";
                                            }
                                            layer.open({
                                                type: 1,
                                                skin: 'layui-layer-lan',
                                                closeBtn: 0,
                                                anim: 2,
                                                shadeClose: true,
                                                title: "请选择草稿进行编辑",
                                                area: ['400px', '300px'],
                                                content: layer_content,
                                                cancel: function() {
                                                    layer.closeAll();
                                                }
                                            });
                                        });
                                    }
                                }
                            }
                        });
                    });
                },

                init_data: function() {
                    let this_ = this;
                    layui.use(["form", "element", "layer", "jquery"], function() {
                        let form = layui.form;
                        let $ = layui.jquery;
                        let layer = layui.layer;
                        let element = layui.element;
                        this_.converter = new showdown.Converter();

                        let draft_data = null;
                        let blog_id = -1;
                        let group_data = [];

                        this_.converter.setOption("omitExtraWLInCodeBlocks", true);
                        this_.converter.setOption("ghCompatibleHeaderId", true);
                        this_.converter.setOption("prefixHeaderId", true);
                        this_.converter.setOption("headerLevelStart", 1);
                        this_.converter.setOption("parseImgDimensions", true);
                        this_.converter.setOption("literalMidWordUnderscores", true);
                        this_.converter.setOption("tables", true);
                        this_.converter.setOption("tablesHeaderId", true);
                        this_.converter.setOption("ghCodeBlocks", true);
                        this_.converter.setOption("tasklists", true);
                        this_.converter.setOption("smartIndentationFix", true);
                        this_.converter.setOption("simpleLineBreaks", true);
                        this_.converter.setOption("requireSpaceBeforeHeadingText", true);
                        this_.converter.setOption("openLinksInNewWindow", true);
                        this_.converter.setOption("backslashEscapesHTMLTags", true);
                        this_.converter.setOption("emoji", true);


                        ace.require("ace/ext/language_tools");
                        this_.editor = ace.edit("editor");
                        this_.editor.session.on("change", function(evt) {
                            $(document.getElementById('html_content').contentWindow.document.body).html(this_.converter.makeHtml(this_.editor.getValue()));
                        });

                        this_.editor.setOption("wrap", "free");
                        this_.editor.setOptions({
                            enableBasicAutocompletion: true,
                            enableSnippets: true,
                            enableLiveAutocompletion: true,
                            wrap: "free",
                            highlightActiveLine: true,
                            highlightSelectedWord: true,
                            selectionStyle: "text",
                            readOnly: false,
                            cursorStyle: "ace",
                            mergeUndoDeltas: "always",
                            behavioursEnabled: true,
                            wrapBehavioursEnabled: true,
                            autoScrollEditorIntoView: true,
                            copyWithEmptySelection: false,
                            useSoftTabs: true,
                            navigateWithinSoftTabs: true,
                            enableMultiselect: true,

                            hScrollBarAlwaysVisible: false,
                            vScrollBarAlwaysVisible: false,
                            highlightGutterLine: true,
                            animatedScroll: true,
                            showInvisibles: true,
                            showPrintMargin: true,
                            printMarginColumn: 80,
                            printMargin: 80,
                            fadeFoldWidgets: true,
                            showFoldWidgets: true,
                            showLineNumbers: true,
                            showGutter: true,
                            displayIndentGuides: true,
                            fontFamily: "Consolas, Monospace, '微软雅黑', 'Heiti SC', '文泉驿微米黑'",
                            fontSize: 13,
                            scrollPastEnd: true,
                            fixedWidthGutter: true,
                            theme: "ace/theme/clouds",

                            mode: "ace/mode/markdown",
                            dragEnabled: true,
                            newLineMode: "auto",
                            foldStyle: "markbeginend",
                            enableSnippets: true,
                            enableEmmet: true,
                            useElasticTabstops: true
                        });



                        if (this_.type === 0) {
                            this_.get_draft_list();
                        } else if (this_.type === 1) {
                            this_.get_draft();
                        } else if (this_.type === 2) {
                            this_.get_blog_content();
                        }

                    });
                }
            },
            mounted: function() {
                let this_ = this;
                on_set_draft_data = this.on_set_draft_data;
                console.log(this.group_data);
                let empty_flag = true;
                for (let k in this.group_data) {
                    console.log(this.group_data[k]);
                    if (this.group_data[k].sub_group.length !== 0) {
                        empty_flag = false;
                        break;
                    }
                }
                if (empty_flag) {
                    layui.use(["layer"], function() {
                        layer.alert("请先添加分组！", () => {
                            window.location.href = "/admin/html/blog_group.html";
                        });
                    });
                } else {
                    this.init_data();
                    this.big_group_change();
                }
            }
        });
    </script>
</body>

</html>